<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>PWA Launch Test</title>
  <style>
    body {
      font-family: system-ui, -apple-system, sans-serif;
      max-width: 800px;
      margin: 50px auto;
      padding: 20px;
      line-height: 1.6;
    }
    .test-result {
      padding: 15px;
      margin: 10px 0;
      border-radius: 5px;
    }
    .success { background: #d4edda; color: #155724; }
    .error { background: #f8d7da; color: #721c24; }
    .info { background: #d1ecf1; color: #0c5460; }
    code { background: #f4f4f4; padding: 2px 6px; border-radius: 3px; }
    button {
      background: #2563eb;
      color: white;
      border: none;
      padding: 10px 20px;
      border-radius: 5px;
      cursor: pointer;
      margin: 5px;
    }
    button:hover { background: #1d4ed8; }
  </style>
</head>
<body>
  <h1>PWA Launch Diagnostic</h1>
  <div id="results"></div>
  <button onclick="runTests()">Run Tests</button>
  <button onclick="testLaunch()">Test Launch</button>

  <script>
    const results = document.getElementById('results');

    function addResult(type, title, message) {
      const div = document.createElement('div');
      div.className = `test-result ${type}`;
      div.innerHTML = `<strong>${title}</strong><br>${message}`;
      results.appendChild(div);
    }

    async function runTests() {
      results.innerHTML = '';
      
      // Test 1: Service Worker
      try {
        if ('serviceWorker' in navigator) {
          const reg = await navigator.serviceWorker.getRegistration();
          if (reg) {
            addResult('success', 'âœ“ Service Worker', `Registered and active. Scope: ${reg.scope}`);
          } else {
            addResult('error', 'âœ— Service Worker', 'Not registered');
          }
        } else {
          addResult('error', 'âœ— Service Worker', 'Not supported');
        }
      } catch (e) {
        addResult('error', 'âœ— Service Worker', `Error: ${e.message}`);
      }

      // Test 2: Manifest
      try {
        const link = document.querySelector('link[rel="manifest"]');
        if (link) {
          const manifestUrl = link.getAttribute('href');
          const response = await fetch(manifestUrl);
          const manifest = await response.json();
          addResult('success', 'âœ“ Manifest', `Found at ${manifestUrl}. Name: ${manifest.name}`);
        } else {
          addResult('error', 'âœ— Manifest', 'No manifest link found');
        }
      } catch (e) {
        addResult('error', 'âœ— Manifest', `Error: ${e.message}`);
      }

      // Test 3: Display Mode
      const isStandalone = window.matchMedia('(display-mode: standalone)').matches;
      const isFullscreen = window.matchMedia('(display-mode: fullscreen)').matches;
      const isMinimalUI = window.matchMedia('(display-mode: minimal-ui)').matches;
      
      if (isStandalone) {
        addResult('success', 'âœ“ Display Mode', 'Running in standalone mode (PWA installed)');
      } else if (isFullscreen) {
        addResult('info', 'â„¹ Display Mode', 'Running in fullscreen mode');
      } else if (isMinimalUI) {
        addResult('info', 'â„¹ Display Mode', 'Running in minimal-ui mode');
      } else {
        addResult('info', 'â„¹ Display Mode', 'Running in browser mode (not installed or viewing in regular tab)');
      }

      // Test 4: Icons
      try {
        const icon192 = await fetch('/icons/icon-192.png');
        const icon512 = await fetch('/icons/icon-512.png');
        if (icon192.ok && icon512.ok) {
          addResult('success', 'âœ“ Icons', 'Both 192x192 and 512x512 icons are accessible');
        } else {
          addResult('error', 'âœ— Icons', 'Icons not accessible');
        }
      } catch (e) {
        addResult('error', 'âœ— Icons', `Error: ${e.message}`);
      }

      // Test 5: HTTPS/localhost
      const isSecure = location.protocol === 'https:' || location.hostname === 'localhost' || location.hostname === '127.0.0.1';
      if (isSecure) {
        addResult('success', 'âœ“ Security', `Running on ${location.protocol}//${location.hostname} (secure context)`);
      } else {
        addResult('error', 'âœ— Security', `Running on ${location.protocol}//${location.hostname} (PWA requires HTTPS or localhost)`);
      }
    }

    function testLaunch() {
      addResult('info', 'â„¹ Launch Test', 'If you see this message, the page loaded successfully. When launching from chrome://apps, Chrome should open this URL in a standalone window.');
      
      // Try to detect if we're in a standalone window
      setTimeout(() => {
        const isStandalone = window.matchMedia('(display-mode: standalone)').matches;
        if (isStandalone) {
          addResult('success', 'âœ“ Launch Success', 'App launched successfully in standalone mode!');
        } else {
          addResult('info', 'â„¹ Launch Info', 'This page loaded, but not in standalone mode. If you launched from chrome://apps and see this, the window may be hidden or minimized.');
        }
      }, 1000);
    }

    // Auto-run tests on load
    window.addEventListener('load', () => {
      runTests();
      // If we're in standalone mode, show success
      if (window.matchMedia('(display-mode: standalone)').matches) {
        setTimeout(() => {
          addResult('success', 'ðŸŽ‰ PWA Launched!', 'This app is running in standalone mode. Everything is working correctly!');
        }, 500);
      }
    });
  </script>
</body>
</html>
