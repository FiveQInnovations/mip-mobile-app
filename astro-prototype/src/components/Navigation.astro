---
import type { MenuItem } from '../lib/api';

interface Props {
  menu: MenuItem[];
  currentPath?: string;
  isHomePage?: boolean;
  donateUrl?: string;
  isFFCI?: boolean;
}

const { menu, currentPath = '', isHomePage = false, donateUrl, isFFCI = false } = Astro.props;

function isActive(uuid: string): boolean {
  if (isHomePage) return false;
  return currentPath.includes(uuid);
}

function isHomeActive(): boolean {
  return isHomePage;
}

// For FFCI: Home (fixed) + all CMS menu items in order (up to 4 items = 5 total)
// For others: Home (fixed) + menu items (up to 4) + Give (if donateUrl), rest in More
let visibleItems: MenuItem[];
let overflowItems: MenuItem[];
let showGive = false;
let giveHref = '';
let giveIsExternal = false;

if (isFFCI) {
  // Show all CMS menu items in order (CMS determines order, including Give)
  // Home (1) + up to 4 CMS items = 5 total
  const MAX_MENU_ITEMS = 4;
  visibleItems = menu.slice(0, MAX_MENU_ITEMS);
  overflowItems = menu.slice(MAX_MENU_ITEMS);
} else {
  // Standard behavior: Home + menu items + Give (if donateUrl)
  showGive = !!donateUrl;
  if (donateUrl) {
    giveHref = donateUrl;
    giveIsExternal = true;
  }
  const MAX_MENU_ITEMS = donateUrl ? 3 : 4;
  visibleItems = menu.slice(0, MAX_MENU_ITEMS);
  overflowItems = menu.slice(MAX_MENU_ITEMS);
}

// Default icon mapping for common navigation items
function getDefaultIcon(label: string): string | null {
  const labelLower = label.toLowerCase();
  
  // Common patterns
  if (labelLower.includes('about') || labelLower.includes('info')) {
    return '‚ÑπÔ∏è';
  } else if (labelLower.includes('contact') || labelLower.includes('connect')) {
    return 'üìû';
  } else if (labelLower.includes('event') || labelLower.includes('calendar')) {
    return 'üìÖ';
  } else if (labelLower.includes('resource') || labelLower.includes('library')) {
    return 'üìö';
  } else if (labelLower.includes('chapter') || labelLower.includes('location') || labelLower.includes('find')) {
    return 'üìç';
  } else if (labelLower.includes('prayer') || labelLower.includes('pray')) {
    return 'üôè';
  } else if (labelLower.includes('chaplain')) {
    return '‚úùÔ∏è';
  } else if (labelLower.includes('donate') || labelLower.includes('give')) {
    return '‚ù§Ô∏è';
  } else if (labelLower.includes('involve') || labelLower.includes('volunteer') || labelLower.includes('join')) {
    return 'ü§ù';
  } else if (labelLower.includes('news') || labelLower.includes('update')) {
    return 'üì∞';
  } else if (labelLower.includes('video') || labelLower.includes('media')) {
    return 'üé•';
  } else if (labelLower.includes('audio') || labelLower.includes('podcast')) {
    return 'üéß';
  } else if (labelLower.includes('bible') || labelLower.includes('scripture')) {
    return 'üìñ';
  } else if (labelLower.includes('home')) {
    return 'üè†';
  }
  
  // Fallback to first letter if no match
  return null;
}

function renderIcon(label: string, icon?: string): string {
  // Use provided icon if available
  if (icon) {
    // If icon is a URL or path, render as image
    if (icon.startsWith('http') || icon.startsWith('/') || icon.startsWith('./')) {
      return `<img src="${icon}" alt="${label}" class="w-5 h-5 object-contain" />`;
    }
    
    // If icon looks like SVG, render inline
    if (icon.trim().startsWith('<svg')) {
      return icon;
    }
    
    // Otherwise treat as emoji or symbol
    return `<span class="text-lg">${icon}</span>`;
  }
  
  // Try to get default icon
  const defaultIcon = getDefaultIcon(label);
  if (defaultIcon) {
    return `<span class="text-lg">${defaultIcon}</span>`;
  }
  
  // Final fallback to first letter
  const firstChar = label.charAt(0).toUpperCase();
  return `<span class="text-lg">${firstChar}</span>`;
}
---

<nav class="fixed bottom-0 left-0 right-0 bg-white border-t border-gray-200 shadow-lg safe-area-bottom" data-testid="bottom-nav">
  <div class="w-full" style="max-width: min(100%, 428px); margin-left: auto; margin-right: auto;">
    <div class="flex justify-around items-center">
      {/* Home button - always present */}
      <a
        href="/"
        class="flex flex-col items-center justify-center min-w-0 flex-1 nav-touch-target"
        data-active={isHomeActive()}
        data-testid="nav-home"
        style={`color: ${
          isHomeActive()
            ? 'var(--color-primary, #2563eb)'
            : 'var(--color-text, #4b5563)'
        };`}
      >
        <span class="text-lg mb-1" set:html={renderIcon('Home', 'üè†')} data-testid="nav-icon"></span>
        <span class="text-xs font-medium truncate w-full text-center">Home</span>
      </a>

      {/* Visible menu items */}
      {visibleItems.map((item) => {
        const active = isActive(item.page.uuid);
        return (
          <a
            href={`/page/${item.page.uuid}`}
            class="flex flex-col items-center justify-center min-w-0 flex-1 nav-touch-target"
            data-active={active}
            data-testid="nav-item"
            style={`color: ${
              active
                ? 'var(--color-primary, #2563eb)'
                : 'var(--color-text, #4b5563)'
            };`}
          >
            <span class="text-lg mb-1" set:html={renderIcon(item.label, item.icon)} data-testid="nav-icon"></span>
            <span class="text-xs font-medium truncate w-full text-center">
              {item.label}
            </span>
          </a>
        );
      })}

      {/* More menu if overflow */}
      {overflowItems.length > 0 && (
        <div class="flex flex-col items-center justify-center min-w-0 flex-1 relative nav-touch-target" data-testid="nav-more">
          <button
            class="flex flex-col items-center justify-center w-full nav-touch-target"
            type="button"
            id="more-menu-button"
            aria-label="More menu"
            style="color: var(--color-text, #4b5563);"
          >
            <span class="text-lg mb-1">‚ãØ</span>
            <span class="text-xs font-medium">More</span>
          </button>
          
          {/* Dropdown menu - hidden by default, shown on click */}
          <div
            class="hidden absolute bottom-full left-0 right-0 mb-2 bg-white border border-gray-200 rounded-lg shadow-lg overflow-hidden"
            id="more-menu-dropdown"
          >
            {overflowItems.map((item) => {
              const active = isActive(item.page.uuid);
              return (
                <a
                  href={`/page/${item.page.uuid}`}
                  class="flex items-center gap-2 px-4 hover:bg-gray-50 border-b border-gray-100 last:border-b-0"
                  data-active={active}
                  style={`color: ${
                    active
                      ? 'var(--color-primary, #2563eb)'
                      : 'var(--color-text, #4b5563)'
                  }; min-height: 44px; padding-top: 12px; padding-bottom: 12px;`}
                >
                  <span class="text-base" set:html={renderIcon(item.label, item.icon)}></span>
                  <span class="text-sm font-medium">{item.label}</span>
                </a>
              );
            })}
          </div>
        </div>
      )}
    </div>
  </div>
</nav>

<script>
  // Handle more menu toggle
  const moreButton = document.getElementById('more-menu-button');
  const moreDropdown = document.getElementById('more-menu-dropdown');
  
  if (moreButton && moreDropdown) {
    moreButton.addEventListener('click', (e) => {
      e.stopPropagation();
      const isHidden = moreDropdown.classList.contains('hidden');
      
      // Close all other dropdowns
      document.querySelectorAll('#more-menu-dropdown').forEach((dropdown) => {
        if (dropdown !== moreDropdown) {
          dropdown.classList.add('hidden');
        }
      });
      
      // Toggle this dropdown
      moreDropdown.classList.toggle('hidden', !isHidden);
    });
    
    // Close dropdown when clicking outside
    document.addEventListener('click', () => {
      moreDropdown.classList.add('hidden');
    });
    
    // Prevent dropdown from closing when clicking inside it
    moreDropdown.addEventListener('click', (e) => {
      e.stopPropagation();
    });
  }
</script>

<style>
  /* Active state styling */
  nav a[data-active="true"],
  nav button[data-active="true"] {
    font-weight: 600;
  }
  
  /* Safe area for notched devices */
  .safe-area-bottom {
    padding-bottom: max(env(safe-area-inset-bottom, 0), 0);
  }
  
  /* Ensure navigation respects safe areas */
  nav {
    padding-left: max(env(safe-area-inset-left, 0), 0);
    padding-right: max(env(safe-area-inset-right, 0), 0);
  }
  
  /* Touch-friendly targets - minimum 44px height */
  nav a.nav-touch-target,
  nav button.nav-touch-target,
  nav div.nav-touch-target {
    min-height: 44px !important;
    padding: 8px 12px !important;
  }
  
  /* Ensure nav items without icons still meet touch target */
  nav a[data-testid="nav-item"],
  nav a[data-testid="nav-home"] {
    min-height: 44px !important;
  }
</style>
