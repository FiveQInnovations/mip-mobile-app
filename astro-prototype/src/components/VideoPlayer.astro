---
import type { VideoData } from '../lib/api';
import 'lite-youtube-embed/src/lite-yt-embed.css';

interface Props {
  video: VideoData;
  title?: string;
  poster?: string | null;
}

const { video, title, poster } = Astro.props;

// Extract YouTube ID from URL if needed
function getYouTubeId(video: VideoData): string | null {
  if (video.source === 'youtube' && video.id) {
    return video.id;
  }
  if (video.url) {
    const ytMatch = video.url.match(
      /(?:youtube\.com\/watch\?v=|youtu\.be\/|youtube\.com\/embed\/)([\w-]{11})/
    );
    if (ytMatch) return ytMatch[1];
  }
  return null;
}

// Extract Vimeo ID from URL if needed
function getVimeoId(video: VideoData): string | null {
  if (video.source === 'vimeo' && video.id) {
    return video.id;
  }
  if (video.url) {
    const vimeoMatch = video.url.match(/vimeo\.com\/(\d+)/);
    if (vimeoMatch) return vimeoMatch[1];
  }
  return null;
}

const youtubeId = getYouTubeId(video);
const vimeoId = getVimeoId(video);
---

<div class="px-4 py-6" data-testid="video-player">
  {title && (
    <h2 class="text-xl font-bold mb-4">{title}</h2>
  )}
  
  <div class="bg-black rounded-lg overflow-hidden">
    {youtubeId ? (
      <!-- YouTube embed using lite-youtube-embed -->
      <lite-youtube
        videoid={youtubeId}
        class="w-full aspect-video"
        style={`background-image: url('https://i.ytimg.com/vi/${youtubeId}/hqdefault.jpg');`}
      ></lite-youtube>
    ) : vimeoId ? (
      <!-- Vimeo embed -->
      <div class="aspect-video flex items-center justify-center bg-gray-900">
        <iframe
          src={`https://player.vimeo.com/video/${vimeoId}?title=0&byline=0&portrait=0`}
          class="w-full h-full"
          frameborder="0"
          allow="autoplay; fullscreen; picture-in-picture"
          allowfullscreen
          data-testid="vimeo-iframe"
        ></iframe>
      </div>
    ) : video.source === 'url' && video.url ? (
      <!-- Direct video URL with HTML5 player -->
      <video
        controls
        class="w-full aspect-video"
        preload="metadata"
        poster={poster || undefined}
        data-testid="video-element"
      >
        <source src={video.url} type="video/mp4" />
        <source src={video.url} type="video/webm" />
        <source src={video.url} type="video/ogg" />
        Your browser does not support the video tag.
      </video>
    ) : (
      <div class="aspect-video flex items-center justify-center text-white">
        <p>Video source not available</p>
      </div>
    )}
  </div>
</div>

<!-- Load lite-youtube-embed JS -->
<script>
  import { trackVideoPlay, trackVideoComplete } from '../lib/analytics';

  if (typeof window !== 'undefined' && !customElements.get('lite-youtube')) {
    import('lite-youtube-embed/src/lite-yt-embed.js');
  }

  // Track video play events
  const videoData = {source: `{video.source}`, url: `{video.url || ''}`, id: `{video.id || ''}`, title: `{video.title || ''}`};
  const youtubeId = `{youtubeId || ''}`;
  const vimeoId = `{vimeoId || ''}`;
  
  // Get content ID from URL if available
  const pathParts = window.location.pathname.split('/');
  const contentId = pathParts[pathParts.length - 1] || undefined;

  // Track video play for different video types
  function setupVideoTracking() {
    // YouTube tracking
    if (youtubeId) {
      const liteYoutube = document.querySelector('lite-youtube');
      if (liteYoutube) {
        liteYoutube.addEventListener('click', () => {
          trackVideoPlay({
            videoId: youtubeId,
            videoSource: 'youtube',
            videoTitle: videoData.title || undefined,
            contentId: contentId,
          });
        });
      }
      
      // Track completion via YouTube iframe API (if available)
      // Note: lite-youtube-embed doesn't expose completion events easily
      // This would require additional setup with YouTube iframe API
    }
    
    // Vimeo tracking
    if (vimeoId) {
      const vimeoIframe = document.querySelector('iframe[src*="vimeo"]') as HTMLIFrameElement;
      if (vimeoIframe) {
        // Vimeo player events require iframe postMessage API
        // For now, track play on iframe load
        vimeoIframe.addEventListener('load', () => {
          trackVideoPlay({
            videoId: vimeoId,
            videoSource: 'vimeo',
            videoTitle: videoData.title || undefined,
            contentId: contentId,
          });
        });
      }
    }
    
    // Direct video URL tracking
    if (videoData.url && videoData.source === 'url') {
      const videoElement = document.querySelector('video[data-testid="video-element"]') as HTMLVideoElement;
      if (videoElement) {
        videoElement.addEventListener('play', () => {
          trackVideoPlay({
            videoId: videoData.url,
            videoSource: 'url',
            videoTitle: videoData.title || undefined,
            contentId: contentId,
          });
        });
        
        videoElement.addEventListener('ended', () => {
          trackVideoComplete({
            videoId: videoData.url,
            videoSource: 'url',
            videoTitle: videoData.title || undefined,
            contentId: contentId,
          });
        });
      }
    }
  }

  // Setup tracking when DOM is ready
  if (document.readyState === 'loading') {
    document.addEventListener('DOMContentLoaded', setupVideoTracking);
  } else {
    setupVideoTracking();
  }
</script>
