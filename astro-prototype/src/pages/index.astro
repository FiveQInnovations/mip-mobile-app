---
import MobileLayout from '../layouts/MobileLayout.astro';
import QuickTasks from '../components/QuickTasks.astro';
import GetConnected from '../components/GetConnected.astro';
import Featured from '../components/Featured.astro';
import { getSiteData } from '../lib/api';
import { getThemeVariables, loadSiteConfig } from '../lib/config';
import type { HomepageType } from '../lib/api';

let siteData;

try {
  siteData = await getSiteData();
} catch (error) {
  console.error('Failed to fetch site data:', error);
  siteData = {
    menu: [],
    site_data: {
      title: 'Error',
      app_name: 'Mobile App',
      logo: null,
      social: []
    }
  };
}

const { menu, site_data } = siteData;
const siteConfig = loadSiteConfig();
const themeVars = getThemeVariables(siteConfig);
const displayLogo = site_data.logo || siteConfig.logo;
const displayName = siteConfig.appName || site_data.app_name;

// Extract donate URL from social links
const donateUrl = site_data.social && Array.isArray(site_data.social)
  ? site_data.social.find(s => s.platform === 'donate' || s.label?.toLowerCase().includes('donate'))?.url
  : undefined;

// Homepage type from config, defaults to 'action-hub' (tested behavior)
const homepageType: HomepageType = siteConfig.homepageType || 'action-hub';
---

<MobileLayout
  title={site_data.title}
  logo={displayLogo}
  appName={displayName}
  menu={menu}
  currentPath="/"
  themeVars={themeVars}
  headerStyle={siteConfig.headerStyle}
>
  <div class="pb-6">
    <!-- Hero Logo Section -->
    {displayLogo && (
      <div class="px-4 py-8 text-center" style="background-color: color-mix(in srgb, var(--color-primary, #2563eb) 5%, var(--color-background, #ffffff));">
        <img
          src={displayLogo}
          alt={displayName}
          class="mx-auto mb-3"
          style="max-width: 200px; max-height: 120px; width: auto; height: auto;"
          data-testid="hero-logo"
        />
        {site_data.title && (
          <h2 class="text-xl font-semibold" style="color: var(--color-text, #0f172a);">
            {site_data.title}
          </h2>
        )}
      </div>
    )}
    
    <!-- Action Hub Homepage: Quick Tasks, Get Connected, Featured -->
    <QuickTasks 
      menu={menu} 
      donateUrl={
        site_data.social && Array.isArray(site_data.social)
          ? site_data.social.find(s => s.platform === 'donate' || s.label?.toLowerCase().includes('donate'))?.url
          : undefined
      } 
    />
    <GetConnected menu={menu} social={site_data.social} />
    <Featured menu={menu} />
  </div>
</MobileLayout>
