---
import MobileLayout from '../../layouts/MobileLayout.astro';
import ContentView from '../../components/ContentView.astro';
import CollectionGrid from '../../components/CollectionGrid.astro';
import VideoPlayer from '../../components/VideoPlayer.astro';
import AudioPlayer from '../../components/AudioPlayer.astro';
import FormEmbed from '../../components/FormEmbed.astro';
import { getSiteData, getPage } from '../../lib/api';
import { getThemeVariables, loadSiteConfig } from '../../lib/config';
import { trackContentView } from '../../lib/analytics';

const { uuid } = Astro.params;

let siteData;
let pageData;
let error: string | null = null;

try {
  [siteData, pageData] = await Promise.all([
    getSiteData(),
    getPage(uuid!)
  ]);
} catch (err) {
  error = err instanceof Error ? err.message : 'Failed to load page';
  console.error('Error loading page:', err);
  
  // Try to at least get site data for layout
  try {
    siteData = await getSiteData();
  } catch {
    siteData = {
      menu: [],
      site_data: {
        title: 'Error',
        app_name: 'Mobile App',
        logo: null,
        social: []
      }
    };
  }
}

const { menu, site_data } = siteData;
const siteConfig = loadSiteConfig();
const themeVars = getThemeVariables(siteConfig);
const displayLogo = site_data.logo || siteConfig.logo;
const displayName = siteConfig.appName || site_data.app_name;

// Track content view for analytics
if (pageData && uuid) {
  trackContentView(
    uuid,
    pageData.page_type || pageData.type || 'unknown',
    pageData.title
  );
}

// Fetch titles for children pages if they don't have titles
let childrenWithTitles = pageData?.children || [];
if (pageData?.children && pageData.children.length > 0) {
  try {
    const childrenPromises = pageData.children.map(async (child) => {
      if (child.title) {
        return child;
      }
      // Fetch the page to get its title
      try {
        const childPage = await getPage(child.uuid);
        return {
          ...child,
          title: childPage.title || child.type
        };
      } catch {
        // If fetch fails, derive title from URL
        const urlPath = child.url ? new URL(child.url).pathname : '';
        const lastSegment = urlPath.split('/').filter(Boolean).pop() || '';
        const derivedTitle = lastSegment
          .split('-')
          .map(word => word.charAt(0).toUpperCase() + word.slice(1))
          .join(' ') || child.type;
        return {
          ...child,
          title: derivedTitle
        };
      }
    });
    childrenWithTitles = await Promise.all(childrenPromises);
  } catch (err) {
    console.error('Error fetching children titles:', err);
    // Fallback: derive titles from URLs
    childrenWithTitles = pageData.children.map((child) => {
      if (child.title) return child;
      const urlPath = child.url ? new URL(child.url).pathname : '';
      const lastSegment = urlPath.split('/').filter(Boolean).pop() || '';
      const derivedTitle = lastSegment
        .split('-')
        .map(word => word.charAt(0).toUpperCase() + word.slice(1))
        .join(' ') || child.type;
      return {
        ...child,
        title: derivedTitle
      };
    });
  }
}
---

<MobileLayout
  title={pageData?.title || 'Page'}
  logo={displayLogo}
  appName={displayName}
  menu={menu}
  currentPath={Astro.url.pathname}
  themeVars={themeVars}
  headerStyle={siteConfig.headerStyle}
>
  {error ? (
    <div class="px-4 py-12 text-center">
      <h2 class="text-xl font-bold mb-2">Error Loading Page</h2>
      <p class="text-gray-600">{error}</p>
      <a href="/" class="mt-4 inline-block text-blue-600 underline">
        Return to Home
      </a>
    </div>
  ) : pageData?.page_type === 'content' ? (
    <>
      {pageData.cover && (
        <img
          src={pageData.cover}
          alt={pageData.title}
          class="w-full aspect-video object-cover"
        />
      )}
      <h1 class="text-2xl font-bold px-4 pt-6 pb-2">{pageData.title}</h1>
      {pageData.page_content && (
        <ContentView html={pageData.page_content} />
      )}
      {pageData.has_form && (
        <div class="px-4">
          <FormEmbed 
            pageUrl={`/page/${uuid}`}
            pageTitle={`Complete ${pageData.title}`}
            embedMode="iframe"
          />
        </div>
      )}
      {childrenWithTitles && childrenWithTitles.length > 0 && (
        <div class="px-4 py-6">
          <h2 class="text-xl font-bold mb-4">Related Pages</h2>
          <div class="space-y-2">
            {childrenWithTitles.map((child) => (
              <a
                href={`/page/${child.uuid}`}
                class="block bg-gray-50 rounded-lg hover:bg-gray-100"
                style="min-height: 44px; padding: 12px; display: flex; align-items: center;"
              >
                <span class="font-medium">{child.title || child.type}</span>
              </a>
            ))}
          </div>
        </div>
      )}
    </>
  ) : pageData?.page_type === 'collection' ? (
    <>
      {pageData.cover && (
        <img
          src={pageData.cover}
          alt={pageData.title}
          class="w-full aspect-video object-cover"
        />
      )}
      <h1 class="text-2xl font-bold px-4 pt-6 pb-2">{pageData.title}</h1>
      {pageData.children && pageData.children.length > 0 ? (
        <CollectionGrid children={pageData.children} />
      ) : (
        <div class="px-4 py-12 text-center">
          <p class="text-gray-600">No items in this collection</p>
        </div>
      )}
    </>
  ) : pageData?.page_type === 'collection-item' ? (
    <>
      {pageData.cover && (
        <img
          src={pageData.cover}
          alt={pageData.title}
          class="w-full aspect-video object-cover"
        />
      )}
      <h1 class="text-2xl font-bold px-4 pt-6 pb-2">{pageData.title}</h1>
      
      {pageData.type === 'video' && pageData.data?.video && (
        <VideoPlayer video={pageData.data.video} poster={pageData.cover} />
      )}
      
      {pageData.type === 'audio' && pageData.data?.audio && (
        <AudioPlayer audio={pageData.data.audio} />
      )}
      
      {pageData.data?.page_content && (
        <ContentView html={pageData.data.page_content} />
      )}
      {pageData.has_form && (
        <div class="px-4">
          <FormEmbed 
            pageUrl={`/page/${uuid}`}
            pageTitle={`Complete ${pageData.title}`}
            embedMode="iframe"
          />
        </div>
      )}
    </>
  ) : (
    <div class="px-4 py-12 text-center">
      <p class="text-gray-600">Unknown page type</p>
    </div>
  )}
</MobileLayout>
