---
import '../styles/global.css';
import Navigation from '../components/Navigation.astro';
import InstallPrompt from '../components/InstallPrompt.astro';
import type { MenuItem } from '../lib/api';

interface Props {
  title: string;
  logo?: string;
  appName?: string;
  menu?: MenuItem[];
  currentPath?: string;
  themeVars?: Record<string, string>;
  headerStyle?: 'light' | 'dark';
  showBackButton?: boolean;
}

const {
  title,
  logo,
  appName,
  menu = [],
  currentPath = '',
  themeVars = {},
  headerStyle = 'light',
  showBackButton = false,
} = Astro.props;

const themeStyle = Object.entries(themeVars)
  .map(([key, value]) => `${key}: ${value}`)
  .join('; ');

// Determine if we're on homepage
const isHomePage = currentPath === '/' || currentPath === '';

// Show back button if explicitly requested or if we're on a content page (not homepage)
const shouldShowBack = showBackButton || (!isHomePage && currentPath.startsWith('/page/'));
---

<html lang="en">
  <head>
    <meta charset="utf-8" />
    <link rel="icon" type="image/svg+xml" href="/favicon.svg" />
    <link rel="manifest" href="/manifest.json" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
    <meta name="generator" content={Astro.generator} />
    <meta name="theme-color" content={themeVars['--color-primary'] || '#2563eb'} />
    <meta name="apple-mobile-web-app-capable" content="yes" />
    <meta name="apple-mobile-web-app-status-bar-style" content={headerStyle === 'dark' ? 'black' : 'default'} />
    <meta name="apple-mobile-web-app-title" content={appName || 'Mobile App'} />
    <title>{title} - {appName || 'Mobile App'}</title>
  </head>
  <body class="min-h-screen flex flex-col" style={themeStyle}>
    <!-- Header -->
    <header
      class="px-4 py-3 shadow-md safe-area-top"
      style="background-color: var(--color-primary, #2563eb); color: var(--color-header-text, #ffffff);"
      data-theme={headerStyle}
    >
      <div class="flex items-center gap-3 w-full px-4" style="max-width: min(100%, 428px); margin-left: auto; margin-right: auto;">
        {/* Back button - shown on content pages */}
        {shouldShowBack && (
          <button
            type="button"
            onclick="window.history.back()"
            data-testid="back-button"
            class="flex items-center justify-center -ml-1"
            aria-label="Go back"
            style="color: var(--color-header-text, #ffffff); min-width: 44px; min-height: 44px; padding: 8px;"
          >
            <svg
              xmlns="http://www.w3.org/2000/svg"
              class="h-6 w-6"
              fill="none"
              viewBox="0 0 24 24"
              stroke="currentColor"
              stroke-width="2"
            >
              <path stroke-linecap="round" stroke-linejoin="round" d="M15 19l-7-7 7-7" />
            </svg>
          </button>
        )}
        
        {/* Logo - links to home */}
        {logo && (
          <a href="/" data-testid="home-link" class="flex items-center flex-shrink-0" style="min-height: 44px; padding: 4px 0;">
            <img src={logo} alt={appName || 'Logo'} class="h-8 w-auto" />
          </a>
        )}
        
        {/* Page title or app name */}
        <h1 class="text-lg font-semibold truncate flex-1">
          {isHomePage ? (appName || title) : title}
        </h1>
      </div>
    </header>

    <!-- Main Content -->
    <main class="flex-1 overflow-y-auto pb-20 w-full" style="max-width: min(100%, 428px); margin-left: auto; margin-right: auto;">
      <slot />
    </main>

    <!-- Bottom Navigation -->
    {menu.length > 0 && (
      <Navigation menu={menu} currentPath={currentPath} isHomePage={isHomePage} />
    )}

    <!-- Install Prompt -->
    <InstallPrompt />

    <script type="module" is:inline>
      import {
        ApiError,
        clearApiCache,
        expireCacheEntryForTesting,
        getMenu,
        getPage,
        getSiteData,
      } from '/src/lib/api.ts';
      import {
        trackAppOpen,
        trackScreenView,
      } from '/src/lib/analytics.ts';

      window.__mipApi = {
        getSiteData,
        getMenu,
        getPage,
        clearApiCache,
        expireCacheEntryForTesting,
        ApiError,
      };

      // Track app open on initial load
      trackAppOpen({appName: `{appName || 'Mobile App'}`});

      // Track screen view for current page
      const currentPath = `{currentPath || '/'}`;
      const screenName = currentPath === '/' ? 'Home' : currentPath.split('/').pop() || 'Page';
      trackScreenView(screenName, currentPath);

      // Register Service Worker
      if ('serviceWorker' in navigator) {
        window.addEventListener('load', () => {
          navigator.serviceWorker
            .register('/sw.js')
            .then((registration) => {
              console.log('Service Worker registered:', registration.scope);
              
              // Check for updates
              registration.addEventListener('updatefound', () => {
                const newWorker = registration.installing;
                if (newWorker) {
                  newWorker.addEventListener('statechange', () => {
                    if (newWorker.state === 'installed' && navigator.serviceWorker.controller) {
                      // New service worker available, prompt user to refresh
                      console.log('New service worker available');
                    }
                  });
                }
              });
            })
            .catch((error) => {
              console.warn('Service Worker registration failed:', error);
            });
        });
      }
    </script>
  </body>
</html>

<style>
  html, body {
    margin: 0;
    padding: 0;
    height: 100%;
  }
  
  body {
    font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
    background-color: var(--color-background, #ffffff);
    color: var(--color-text, #0f172a);
  }
  
  /* Safe area for notched devices */
  .safe-area-top {
    padding-top: max(env(safe-area-inset-top, 0), 0);
  }
  
  /* Ensure header respects safe area */
  header {
    padding-left: max(env(safe-area-inset-left, 0), 16px);
    padding-right: max(env(safe-area-inset-right, 0), 16px);
  }
  
  /* Back button hover state */
  button[data-testid="back-button"]:hover {
    opacity: 0.8;
  }
  
  button[data-testid="back-button"]:active {
    opacity: 0.6;
  }
  
  /* Ensure main content respects safe areas */
  main {
    padding-left: max(env(safe-area-inset-left, 0), 0);
    padding-right: max(env(safe-area-inset-right, 0), 0);
  }
</style>
